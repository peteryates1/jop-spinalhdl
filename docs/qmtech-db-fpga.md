# QMTECH DB_FPGA Daughter Board

## Overview

Universal daughter board for QMTECH FPGA core boards. Connects via dual 32×2 pin
headers (J2, J3) at 0.1" pitch. Confirmed compatible with:

- **QMTECH EP4CGX150** (Cyclone IV GX) — primary JOP platform
- **QMTECH EP4CE15** (Cyclone IV E) — has example projects for all peripherals
- **QMTECH XC7A75T/100T/200T** (Artix-7) — potential JOP DDR3 + DB_FPGA platform

GitHub: <https://github.com/ChinaQMTECH/DB_FPGA>

Reference files: `/srv/git/qmtech/DB_FPGA/`

Schematic: `QMTECH_DB_For_FPGA_V04.pdf` (V04, without RP2040)
Enhanced version: `/srv/git/qmtech/DB_FPGA_with_RP2040/DB_FPGA_V5-20221108.pdf` (V05, with RP2040)

## Peripherals

| Peripheral | Component | Interface | Status in JOP |
|------------|-----------|-----------|--------------|
| **Ethernet** | RTL8211EG PHY | GMII 8-bit (1 Gbps) | Working — `BmbEth` + `BmbMdio` |
| **UART** | CP2102N USB-to-UART | TX/RX + USB | Working — `BmbUart` (1 Mbaud) |
| **VGA** | Direct RGB (5-6-5) | 15-pin D-sub | Working — `BmbVgaText` (80×30) |
| **SD card** | microSD slot | Native 4-bit / SPI | Working — `BmbSdNative` / `BmbSdSpi` |
| **7-segment** | 3-digit (2352B) | Multiplexed 8+3 lines | Not used by JOP |
| **PMOD** | J10, J11 connectors | 12-pin GPIO each | Available for expansion |

## Pin Assignments (EP4CGX150)

Pin assignments are board-specific because the connector-to-FPGA mapping differs
per core board. These are the EP4CGX150 assignments from the JOP project
(`fpga/qmtech-ep4cgx150-sdram/jop_dbfpga.qsf`).

### UART (CP2102N)

| Signal | Pin | Direction |
|--------|-----|-----------|
| `ser_txd` | PIN_AD20 | FPGA → CP2102N |
| `ser_rxd` | PIN_AE21 | CP2102N → FPGA |

### Ethernet (RTL8211EG, GMII)

**Management:**

| Signal | Pin |
|--------|-----|
| `e_mdc` | PIN_A20 |
| `e_mdio` | PIN_A21 |
| `e_resetn` | PIN_A15 |

**Receive path:**

| Signal | Pin |
|--------|-----|
| `e_rxc` | PIN_B10 |
| `e_rxdv` | PIN_A8 |
| `e_rxd[0]` | PIN_A9 |
| `e_rxd[1]` | PIN_B9 |
| `e_rxd[2]` | PIN_C10 |
| `e_rxd[3]` | PIN_A10 |
| `e_rxd[4]` | PIN_A11 |
| `e_rxd[5]` | PIN_B11 |
| `e_rxd[6]` | PIN_A12 |
| `e_rxd[7]` | PIN_A13 |

**Transmit path:**

| Signal | Pin |
|--------|-----|
| `e_gtxc` | PIN_C13 |
| `e_txen` | PIN_C14 |
| `e_txer` | PIN_A19 |
| `e_txd[0]` | PIN_C15 |
| `e_txd[1]` | PIN_B15 |
| `e_txd[2]` | PIN_A16 |
| `e_txd[3]` | PIN_A17 |
| `e_txd[4]` | PIN_C16 |
| `e_txd[5]` | PIN_B18 |
| `e_txd[6]` | PIN_C17 |
| `e_txd[7]` | PIN_A18 |

**RX error:**

| Signal | Pin |
|--------|-----|
| `e_rxer` | PIN_C11 |

GMII TX requires a 125 MHz clock on `e_gtxc` (generated by FPGA PLL).
RX clock (`e_rxc`) is source-synchronous from the PHY at 125 MHz.
See [DB_FPGA Ethernet](db-fpga-ethernet.md) for timing constraints and PHY config.

### VGA (RGB 5-6-5)

| Signal | Pin |
|--------|-----|
| `vga_hs` | PIN_A6 |
| `vga_vs` | PIN_A7 |
| `vga_r[4:0]` | PIN_D1, PIN_B1, PIN_E2, PIN_C1, PIN_E1 |
| `vga_g[5:0]` | PIN_C5, PIN_A4, PIN_A3, PIN_C4, PIN_A2, PIN_B2 |
| `vga_b[4:0]` | PIN_B6, PIN_B7, PIN_A5, PIN_B5, PIN_B4 |

Pixel clock (25 MHz for 640×480@60Hz) from PLL c3.
See [DB_FPGA VGA Text](db-fpga-vga-text.md) for register map and Java API.

### SD Card (Native 4-bit / SPI)

| Signal | Pin | Native mode | SPI mode |
|--------|-----|-------------|----------|
| `sd_clk` | PIN_B21 | SD_CLK | SPI_CLK |
| `sd_cmd` | PIN_A22 | CMD line | MOSI |
| `sd_dat_0` | PIN_A23 | DAT0 | MISO |
| `sd_dat_1` | PIN_B23 | DAT1 | — |
| `sd_dat_2` | PIN_B19 | DAT2 | — |
| `sd_dat_3` | PIN_C19 | DAT3/CS | CS |
| `sd_cd` | PIN_B22 | Card detect | Card detect |

See [DB_FPGA SD Card](db-fpga-sd-card.md) for native mode details.

### 7-Segment Display (3-digit, active low)

| Signal | Pin | Function |
|--------|-----|----------|
| `SS_Seg[0]` (A) | PIN_AF15 | Segment A |
| `SS_Seg[1]` (B) | PIN_AD18 | Segment B |
| `SS_Seg[2]` (C) | PIN_AF17 | Segment C |
| `SS_Seg[3]` (D) | PIN_AF16 | Segment D |
| `SS_Seg[4]` (E) | PIN_AD16 | Segment E |
| `SS_Seg[5]` (F) | PIN_AC17 | Segment F |
| `SS_Seg[6]` (G) | PIN_AC18 | Segment G |
| `SS_DP` | PIN_AD17 | Decimal point |
| `SS_Scan[0]` | PIN_AE14 | Digit 1 select (active low) |
| `SS_Scan[1]` | PIN_AE17 | Digit 2 select (active low) |
| `SS_Scan[2]` | PIN_AC16 | Digit 3 select (active low) |

### Additional LEDs (active low)

| Signal | Pin |
|--------|-----|
| `led[2]` | PIN_AD14 |
| `led[3]` | PIN_AC14 |
| `led[4]` | PIN_AD15 |
| `led[5]` | PIN_AC15 |
| `led[6]` | PIN_AE15 |

### DIP Switches

| Signal | Pin |
|--------|-----|
| `switch[2]` | PIN_C21 |
| `switch[3]` | PIN_AD10 |
| `switch[4]` | PIN_AC10 |
| `switch[5]` | PIN_AF12 |
| `switch[6]` | PIN_AF11 |

### PMOD J10 (12-pin, 2×6)

| Pin | FPGA Pin | | Pin | FPGA Pin |
|:---:|----------|--|:---:|----------|
| 1 | PIN_AF21 | | 7 | PIN_AF20 |
| 2 | PIN_AF19 | | 8 | PIN_AE19 |
| 3 | PIN_AD19 | | 9 | PIN_AC19 |
| 4 | PIN_AF18 | | 10 | PIN_AE18 |
| 5 | GND | | 11 | GND |
| 6 | 3.3V | | 12 | 3.3V |

### PMOD J11 (12-pin, 2×6)

| Pin | FPGA Pin | | Pin | FPGA Pin |
|:---:|----------|--|:---:|----------|
| 1 | PIN_AF25 | | 7 | PIN_AF24 |
| 2 | PIN_AD21 | | 8 | PIN_AC21 |
| 3 | PIN_AF23 | | 9 | PIN_AE23 |
| 4 | PIN_AF22 | | 10 | PIN_AE22 |
| 5 | GND | | 11 | GND |
| 6 | 3.3V | | 12 | 3.3V |

### JP1 GPIO Header (18-pin, 2×9)

| Pin | FPGA Pin | | Pin | FPGA Pin |
|:---:|----------|--|:---:|----------|
| 1 | 3.3V | | 2 | GND |
| 3 | PIN_AD4 (4.7K pull-up) | | 4 | PIN_AC4 (4.7K pull-up) |
| 5 | PIN_AE3 | | 6 | PIN_AD3 |
| 7 | PIN_AF5 | | 8 | PIN_AF4 |
| 9 | PIN_AD6 | | 10 | PIN_AD5 |
| 11 | PIN_AE6 | | 12 | PIN_AE5 |
| 13 | PIN_AF6 | | 14 | PIN_AE7 |
| 15 | PIN_AF8 | | 16 | PIN_AF7 |
| 17 | PIN_AF9 | | 18 | PIN_AE9 |

## Pin Assignments (EP4CE15)

From `/srv/git/qmtech/CYCLONE_IV_EP4CE15/Software/` example projects.
Different FPGA package → different pin numbers for the same connector positions.

### UART

| Signal | Pin |
|--------|-----|
| RXD | PIN_J2 |
| TXD | PIN_J1 |

### Ethernet (RTL8211EG, GMII)

**Management:**

| Signal | Pin |
|--------|-----|
| `e_mdc` | PIN_AB17 |
| `e_mdio` | PIN_AA17 |
| `e_reset` | PIN_W21 |

**Receive path:**

| Signal | Pin |
|--------|-----|
| `e_rxc` | PIN_M22 |
| `e_rxdv` | PIN_K21 |
| `e_rxer` | PIN_R21 |
| `e_rxd[0]` | PIN_K22 |
| `e_rxd[1]` | PIN_L21 |
| `e_rxd[2]` | PIN_L22 |
| `e_rxd[3]` | PIN_M21 |
| `e_rxd[4]` | PIN_N21 |
| `e_rxd[5]` | PIN_N22 |
| `e_rxd[6]` | PIN_P21 |
| `e_rxd[7]` | PIN_P22 |

**Transmit path:**

| Signal | Pin |
|--------|-----|
| `e_gtxc` | PIN_U22 |
| `e_txc` | PIN_AB20 |
| `e_txen` | PIN_V21 |
| `e_txer` | PIN_AA18 |
| `e_txd[0]` | PIN_V22 |
| `e_txd[1]` | PIN_W22 |
| `e_txd[2]` | PIN_Y21 |
| `e_txd[3]` | PIN_Y22 |
| `e_txd[4]` | PIN_AA20 |
| `e_txd[5]` | PIN_AB19 |
| `e_txd[6]` | PIN_AA19 |
| `e_txd[7]` | PIN_AB18 |

### VGA (RGB 5-6-5)

| Signal | Pin |
|--------|-----|
| `vga_hs` | PIN_J21 |
| `vga_vs` | PIN_J22 |
| `vga_r[0]` | PIN_M19 |
| `vga_r[1]` | PIN_N19 |
| `vga_r[2]` | PIN_M20 |
| `vga_r[3]` | PIN_B21 |
| `vga_r[4]` | PIN_N20 |
| `vga_g[0]` | PIN_B22 |
| `vga_g[1]` | PIN_C21 |
| `vga_g[2]` | PIN_D21 |
| `vga_g[3]` | PIN_C22 |
| `vga_g[4]` | PIN_E21 |
| `vga_g[5]` | PIN_D22 |
| `vga_b[0]` | PIN_E22 |
| `vga_b[1]` | PIN_F22 |
| `vga_b[2]` | PIN_F21 |
| `vga_b[3]` | PIN_H22 |
| `vga_b[4]` | PIN_H21 |

### SD Card (SPI mode)

| Signal | Pin |
|--------|-----|
| CLK | PIN_AA15 |
| CS | PIN_AA16 |
| MOSI (CMD) | PIN_AB15 |
| MISO (DAT0) | PIN_AB14 |

### 7-Segment Display

| Signal | Pin |
|--------|-----|
| `SMG_Data[0]` | PIN_C4 |
| `SMG_Data[1]` | PIN_B2 |
| `SMG_Data[2]` | PIN_A3 |
| `SMG_Data[3]` | PIN_C3 |
| `SMG_Data[4]` | PIN_A5 |
| `SMG_Data[5]` | PIN_B4 |
| `SMG_Data[6]` | PIN_B1 |
| `SMG_Data[7]` | PIN_A4 |
| `Scan_Sig[0]` | PIN_B5 |
| `Scan_Sig[1]` | PIN_B3 |
| `Scan_Sig[2]` | PIN_B6 |

## Example Projects

Complete working examples in `/srv/git/qmtech/CYCLONE_IV_EP4CE15/Software/`:

| Project | Peripheral | Description |
|---------|-----------|-------------|
| Project05_CP2102_UART_V2 | UART | Echo test, 9600 baud |
| Project06_7SEG_LED | 7-segment | 3-digit multiplexed display |
| Project07_MicroSD | SD card | SPI mode read/write |
| Project08_VGA | VGA | 1024×768@60Hz, 16-bit color, test patterns |
| Project09_GMII_Ethernet | Ethernet | GMII + UDP/IP stack |

## Power

- 3.3V digital (from core board via headers)
- 1.0V + 3.3V analog for Ethernet PHY
- 100 nF decoupling on power pins, 4.7 µF bulk
- 4.7 kΩ pull-ups on MDIO
- 330 Ω current limiting on LEDs
