# -------------------------------------------------------------------------- #
# JOP 8-Core SMP Test - QMTECH EP4CGX150 Core Board + DB_FPGA
#
# 8-core SMP JOP with per-core UART TX on JP1 header for Pico debug probe
# -------------------------------------------------------------------------- #

set_global_assignment -name FAMILY "Cyclone IV GX"
set_global_assignment -name DEVICE EP4CGX150DF27I7
set_global_assignment -name TOP_LEVEL_ENTITY JopSmpSdramTop
set_global_assignment -name PROJECT_OUTPUT_DIRECTORY output_files
set_global_assignment -name MIN_CORE_JUNCTION_TEMP "-40"
set_global_assignment -name MAX_CORE_JUNCTION_TEMP 100
set_global_assignment -name ERROR_CHECK_FREQUENCY_DIVISOR 1
set_global_assignment -name NOMINAL_CORE_SUPPLY_VOLTAGE 1.2V

# Source files
set_global_assignment -name VERILOG_FILE ../../spinalhdl/generated/JopSmpSdramTop.v
set_global_assignment -name VHDL_FILE dram_pll.vhd
set_global_assignment -name SDC_FILE jop_sdram.sdc
set_global_assignment -name VERILOG_FILE ../../fpga/ip/altera_sdram_tri_controller/altera_sdram_tri_controller.v
set_global_assignment -name VERILOG_FILE ../../fpga/ip/altera_sdram_tri_controller/efifo_module.v

# I/O standard
set_global_assignment -name STRATIX_DEVICE_IO_STANDARD "3.3-V LVCMOS"

# Configuration
set_global_assignment -name ENABLE_OCT_DONE OFF
set_global_assignment -name ENABLE_CONFIGURATION_PINS OFF
set_global_assignment -name ENABLE_BOOT_SEL_PIN OFF
set_global_assignment -name USE_CONFIGURATION_DEVICE OFF
set_global_assignment -name ACTIVE_SERIAL_CLOCK FREQ_40MHZ

# I/O timing
set_global_assignment -name OUTPUT_IO_TIMING_NEAR_END_VMEAS "HALF VCCIO" -rise
set_global_assignment -name OUTPUT_IO_TIMING_NEAR_END_VMEAS "HALF VCCIO" -fall
set_global_assignment -name OUTPUT_IO_TIMING_FAR_END_VMEAS "HALF SIGNAL SWING" -rise
set_global_assignment -name OUTPUT_IO_TIMING_FAR_END_VMEAS "HALF SIGNAL SWING" -fall

# -------------------------------------------------------------------------- #
# Pin Assignments - QMTECH EP4CGX150 Core Board
# -------------------------------------------------------------------------- #

# 50 MHz Clock
set_location_assignment PIN_B14 -to clk_in

# UART TX/RX (CP2102N on daughter board â€” core 0 serial download)
set_location_assignment PIN_AD20 -to ser_txd
set_location_assignment PIN_AE21 -to ser_rxd

# LEDs: 2 core board + 5 DB_FPGA + 1 PMOD = 8 (one per core)
set_location_assignment PIN_A25  -to led[0]
set_location_assignment PIN_A24  -to led[1]
set_location_assignment PIN_AD14 -to led[2]
set_location_assignment PIN_AC14 -to led[3]
set_location_assignment PIN_AD15 -to led[4]
set_location_assignment PIN_AC15 -to led[5]
set_location_assignment PIN_AE15 -to led[6]
set_location_assignment PIN_AF21 -to led[7]

# SDRAM clock (PLL c2: 80 MHz, -3ns phase shift)
set_location_assignment PIN_E22 -to sdram_clk

# SDRAM control
set_location_assignment PIN_H26 -to sdram_CSn
set_location_assignment PIN_K24 -to sdram_CKE
set_location_assignment PIN_G25 -to sdram_WEn
set_location_assignment PIN_H25 -to sdram_RASn
set_location_assignment PIN_G26 -to sdram_CASn

# SDRAM bank address
set_location_assignment PIN_J25 -to sdram_BA[0]
set_location_assignment PIN_J26 -to sdram_BA[1]

# SDRAM address
set_location_assignment PIN_L25 -to sdram_ADDR[0]
set_location_assignment PIN_L26 -to sdram_ADDR[1]
set_location_assignment PIN_M25 -to sdram_ADDR[2]
set_location_assignment PIN_M26 -to sdram_ADDR[3]
set_location_assignment PIN_N22 -to sdram_ADDR[4]
set_location_assignment PIN_N23 -to sdram_ADDR[5]
set_location_assignment PIN_N24 -to sdram_ADDR[6]
set_location_assignment PIN_M22 -to sdram_ADDR[7]
set_location_assignment PIN_M24 -to sdram_ADDR[8]
set_location_assignment PIN_L23 -to sdram_ADDR[9]
set_location_assignment PIN_K26 -to sdram_ADDR[10]
set_location_assignment PIN_L24 -to sdram_ADDR[11]
set_location_assignment PIN_K23 -to sdram_ADDR[12]

# SDRAM data mask
set_location_assignment PIN_F26 -to sdram_DQM[0]
set_location_assignment PIN_H24 -to sdram_DQM[1]

# SDRAM data bus
set_location_assignment PIN_B25 -to sdram_DQ[0]
set_location_assignment PIN_B26 -to sdram_DQ[1]
set_location_assignment PIN_C25 -to sdram_DQ[2]
set_location_assignment PIN_C26 -to sdram_DQ[3]
set_location_assignment PIN_D25 -to sdram_DQ[4]
set_location_assignment PIN_D26 -to sdram_DQ[5]
set_location_assignment PIN_E25 -to sdram_DQ[6]
set_location_assignment PIN_E26 -to sdram_DQ[7]
set_location_assignment PIN_H23 -to sdram_DQ[8]
set_location_assignment PIN_G24 -to sdram_DQ[9]
set_location_assignment PIN_G22 -to sdram_DQ[10]
set_location_assignment PIN_F24 -to sdram_DQ[11]
set_location_assignment PIN_F23 -to sdram_DQ[12]
set_location_assignment PIN_E24 -to sdram_DQ[13]
set_location_assignment PIN_D24 -to sdram_DQ[14]
set_location_assignment PIN_C24 -to sdram_DQ[15]

# -------------------------------------------------------------------------- #
# Pin Assignments - JP1 Header: Per-Core UART TX
#
# Each core's TXD is routed to a JP1 pin connected to a Pico GPIO (even pins).
# Core 0 also drives ser_txd (CP2102N) for serial download.
#
# Core | jp1 idx | FPGA Pin | Pico GP
# -----|---------|----------|--------
#   0  |   14    | PIN_AF9  | GP0
#   1  |   12    | PIN_AF8  | GP2
#   2  |   10    | PIN_AF6  | GP4
#   3  |    8    | PIN_AE6  | GP6
#   4  |    6    | PIN_AD6  | GP8
#   5  |    4    | PIN_AF5  | GP10
#   6  |    2    | PIN_AE3  | GP12
#   7  |    0    | PIN_AD4  | GP14
# -------------------------------------------------------------------------- #

set_location_assignment PIN_AF9 -to jp1_txd[0]
set_location_assignment PIN_AF8 -to jp1_txd[1]
set_location_assignment PIN_AF6 -to jp1_txd[2]
set_location_assignment PIN_AE6 -to jp1_txd[3]
set_location_assignment PIN_AD6 -to jp1_txd[4]
set_location_assignment PIN_AF5 -to jp1_txd[5]
set_location_assignment PIN_AE3 -to jp1_txd[6]
set_location_assignment PIN_AD4 -to jp1_txd[7]

# Per-core watchdog output (odd JP1 pins, adjacent to TXD)
#
# Core | jp1 idx | FPGA Pin | Pico GP
# -----|---------|----------|--------
#   0  |   15    | PIN_AE9  | GP1
#   1  |   13    | PIN_AF7  | GP3
#   2  |   11    | PIN_AE7  | GP5
#   3  |    9    | PIN_AE5  | GP7
#   4  |    7    | PIN_AD5  | GP9
#   5  |    5    | PIN_AF4  | GP11
#   6  |    3    | PIN_AD3  | GP13
#   7  |    1    | PIN_AC4  | GP15

set_location_assignment PIN_AE9 -to jp1_wd[0]
set_location_assignment PIN_AF7 -to jp1_wd[1]
set_location_assignment PIN_AE7 -to jp1_wd[2]
set_location_assignment PIN_AE5 -to jp1_wd[3]
set_location_assignment PIN_AD5 -to jp1_wd[4]
set_location_assignment PIN_AF4 -to jp1_wd[5]
set_location_assignment PIN_AD3 -to jp1_wd[6]
set_location_assignment PIN_AC4 -to jp1_wd[7]

# -------------------------------------------------------------------------- #
# SignalTap II Logic Analyzer
# -------------------------------------------------------------------------- #

set_global_assignment -name ENABLE_SIGNALTAP OFF

# -------------------------------------------------------------------------- #
# Partitions
# -------------------------------------------------------------------------- #

set_global_assignment -name PARTITION_NETLIST_TYPE SOURCE -section_id Top
set_global_assignment -name PARTITION_FITTER_PRESERVATION_LEVEL PLACEMENT_AND_ROUTING -section_id Top
set_global_assignment -name PARTITION_COLOR 16764057 -section_id Top
set_instance_assignment -name PARTITION_HIERARCHY root_partition -to | -section_id Top

set_global_assignment -name LAST_QUARTUS_VERSION "18.1.1 Lite Edition"
